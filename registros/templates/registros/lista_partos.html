{% extends "base.html" %}
{% block title %}Lista de Partos · Obstetricia{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Lista de Partos</h3>
  <div class="d-flex gap-2">
    <a href="{% url 'registros:registro_parto' %}" class="btn btn-primary">Nuevo registro</a>
    <form method="get" id="export-form" class="d-flex align-items-center">
      <input type="date" name="start" class="form-control form-control-sm me-1" value=""> 
      <input type="date" name="end" class="form-control form-control-sm me-1" value="">
      <a href="#" id="export-btn" class="btn btn-outline-success btn-sm">Exportar</a>
    </form>
  </div>
</div>

<form method="get" class="mb-3">
  <div class="input-group">
    <input type="text" name="q" value="{{ query }}" placeholder="Buscar por RUT, nombre o apellido" class="form-control">
    <button class="btn btn-outline-secondary" type="submit">Buscar</button>
  </div>
</form>

{% if partos %}
<table class="table table-striped table-hover">
  <thead>
    <tr>
      <th>RUT</th>
      <th>Madre</th>
      <th>Fecha y hora</th>
      <th>Registrado por</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for parto in partos %}
    <tr>
      <td>{{ parto.madre.rut }}</td>
      <td>{{ parto.madre.nombres }} {{ parto.madre.apellidos }}</td>
      <td>{{ parto.fecha_hora|date:"SHORT_DATETIME_FORMAT" }}</td>
      <td>{{ parto.created_by.get_full_name|default:parto.created_by.username }}</td>
      <td>
        <a href="{% url 'registros:detalle_parto' parto.id %}" class="btn btn-sm btn-outline-primary">Ver</a>
        <a href="{% url 'registros:editar_parto' parto.id %}" class="btn btn-sm btn-outline-secondary">Editar</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if partos.has_previous %}
    <li class="page-item"><a class="page-link" href="?q={{ query }}&page={{ partos.previous_page_number }}">Anterior</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Anterior</span></li>
    {% endif %}

    <li class="page-item active"><span class="page-link">Página {{ partos.number }} de {{ partos.paginator.num_pages }}</span></li>

    {% if partos.has_next %}
    <li class="page-item"><a class="page-link" href="?q={{ query }}&page={{ partos.next_page_number }}">Siguiente</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
    {% endif %}
  </ul>
</nav>

{% else %}
<p class="text-muted">No se encontraron registros.</p>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('export-btn').addEventListener('click', function(e){
  e.preventDefault();
  const form = document.getElementById('export-form');
  const start = form.elements['start'].value;
  const end = form.elements['end'].value;
  let url = "{% url 'registros:exportar_partos' %}";
  const params = new URLSearchParams();
  if (start) params.append('start', start);
  if (end) params.append('end', end);
  if ([...params].length) url += '?' + params.toString();
  window.location = url;
});
</script>
{% endblock %}
